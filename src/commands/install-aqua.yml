description: >
  Install clivm.
parameters:
  version:
    type: string
    description: >
      clivm version.
  install_path:
    type: string
    default: /usr/local/bin/clivm
    description: >
      install path
  cache_version:
    type: string
    default: v1
    description: >
      cache version.
steps:
  - restore_cache:
      keys:
        - << parameters.cache_version >>-clivm-<< parameters.version >>

  - run:
      name: Install clivm
      command: |
        version="<< parameters.version >>"
        install_path="<< parameters.install_path >>"

        temp_path="/tmp/clivm-$version"
        if [ -f "$temp_path" ]; then
          cp "$temp_path" "$install_path" || sudo cp "$temp_path" "$install_path"
          exit 0
        fi

        uname_os() {
          local os
          os=$(uname -s | tr '[:upper:]' '[:lower:]')
          case "$os" in
            cygwin_nt*) os="windows" ;;
            mingw*) os="windows" ;;
            msys_nt*) os="windows" ;;
          esac
          echo "$os"
        }

        uname_arch() {
          local arch
          arch=$(uname -m)
          case $arch in
            x86_64) arch="amd64" ;;
            aarch64) arch="arm64" ;;
          esac
          echo ${arch}
        }

        OS="$(uname_os)"
        ARCH="$(uname_arch)"

        mkdir -p "$(dirname "$install_path")"

        URL=https://github.com/clivm/clivm/releases/download/${version}/clivm_${OS}_${ARCH}.tar.gz
        tempdir=$(mktemp -d)
        echo "===> Downloading $URL ..." >&2
        curl --fail -L "$URL" -o "$tempdir/clivm_${OS}_${ARCH}.tar.gz"

        (cd "$tempdir"; tar xvzf "clivm_${OS}_${ARCH}.tar.gz" > /dev/null)
        echo "===> Install clivm $version ($OS/$ARCH) to $install_path" >&2

        cp "$tempdir/clivm" "/tmp/clivm-$version"
        mv "$tempdir/clivm" "$install_path" || sudo mv "$tempdir/clivm" "$install_path"
        rm -R "$tempdir"

  - save_cache:
      key: << parameters.cache_version >>-clivm-<< parameters.version >>
      paths:
        - /tmp/clivm-<< parameters.version >>

  - run:
      command: rm /tmp/clivm-<< parameters.version >>
